# RISC-V VDSO 时间缓存优化测试方案

## 一、测试目标

验证 RISC-V VDSO 时间缓存优化的有效性和正确性，确保：
1. **功能正确性**: 时间戳返回值准确，无逻辑错误
2. **性能提升**: 高频调用场景下性能提升 70-95%
3. **精度可接受**: 时间精度损失在可接受范围内 (< 1μs)
4. **无回归**: 对现有功能无负面影响

---

## 二、测试环境

### 2.1 硬件要求

| 组件 | 要求 |
|------|------|
| 架构 | RISC-V (64位) |
| CPU | 任意支持 RISC-V 的处理器 |
| 内存 | ≥ 512MB |
| 时钟源 | CSR_TIME (M-mode timer) |

### 2.2 软件要求

| 软件 | 版本要求 |
|------|----------|
| Linux 内核 | 包含 VDSO 时间缓存补丁 |
| GCC | ≥ 8.0 |
| Perl | ≥ 5.0 (用于内核构建) |
| Bash | ≥ 4.0 |

### 2.3 内核配置

必须启用的配置项：
```
CONFIG_GENERIC_GETTIMEOFDAY=y
CONFIG_RISCV_VDSO_TIME_CACHE=y
```

---

## 三、测试用例设计

### 3.1 功能测试 (F001-F005)

| 用例ID | 测试项 | 测试方法 | 预期结果 |
|--------|--------|----------|----------|
| F001 | 基本时间获取 | 调用 clock_gettime() | 成功返回时间戳 |
| F002 | 单调性检查 | 连续调用 10000 次 | 时间严格递增 |
| F003 | 多时钟源 | 测试 REALTIME/MONOTONIC | 全部正常工作 |
| F004 | 缓存更新 | 等待内核更新 VDSO | 缓存自动失效 |
| F005 | 多核一致性 | 在不同 CPU 上调用 | 时间单调递增 |

### 3.2 性能测试 (P001-P006)

| 用例ID | 测试场景 | 调用频率 | 性能目标 |
|--------|----------|----------|----------|
| P001 | 单次调用开销 | N/A | < 50 周期 (缓存命中) |
| P002 | 高频循环 | 10^6 calls/s | 8-10x 提升 |
| P003 | 中频调用 | 10^5 calls/s | 5-8x 提升 |
| P004 | 低频调用 | 10^4 calls/s | 3-5x 提升 |
| P005 | AI 推理模拟 | 批量调用 | 70-95% 陷阱减少 |
| P006 | 日志记录模拟 | 间隔调用 | 60-80% 性能提升 |

### 3.3 精度测试 (A001-A004)

| 用例ID | 测试项 | 测试方法 | 精度要求 |
|--------|--------|----------|----------|
| A001 | 绝对精度 | 与系统调用对比 | < 1μs 误差 |
| A002 | 相对精度 | 连续调用间隔 | 无负值间隔 |
| A003 | 时间流逝 | sleep() 后验证 | 误差 < 10% |
| A004 | 缓存新鲜度 | 快速连续读取 | 误差 < 缓存有效期 |

### 3.4 压力测试 (S001-S003)

| 用例ID | 测试项 | 测试方法 | 预期结果 |
|--------|--------|----------|----------|
| S001 | 长时间运行 | 运行 24 小时 | 无内存泄漏 |
| S002 | 多进程并发 | 100 个进程同时测试 | 无崩溃 |
| S003 | 上下文切换 | 进程迁移测试 | 时间单调 |

---

## 四、测试程序

### 4.1 核心测试程序: `vdso_cache_test.c`

完整的 C 测试程序，包含：
- 功能测试模块
- 性能测试模块
- 精度测试模块
- 自动化报告生成

### 4.2 性能基准程序: `vdso_perf_benchmark.c`

专门的性能测试程序，用于：
- 单次调用延迟测量
- 吞吐量测试
- 缓存命中率统计

### 4.3 内核模块: `cache_invalidate_test.ko`

测试缓存失效机制的内核模块

---

## 五、测试执行步骤

### 5.1 准备阶段

```bash
# 1. 检查内核配置
zcat /proc/config.gz | grep RISCV_VDSO_TIME_CACHE
# 预期: CONFIG_RISCV_VDSO_TIME_CACHE=y

# 2. 检查 VDSO 是否可用
ldd /bin/ls | grep vdso
# 应该显示 vdso 加载

# 3. 编译测试程序
make clean && make
```

### 5.2 执行测试

```bash
# 快速测试 (5分钟)
./run_tests.sh --quick

# 完整测试 (30分钟)
./run_tests.sh --full

# 性能专项测试
./run_tests.sh --performance

# 精度专项测试
./run_tests.sh --accuracy
```

### 5.3 生成报告

```bash
# 生成 HTML 报告
./run_tests.sh --report > test_report.html

# 生成 JSON 报告
./run_tests.sh --json > test_results.json
```

---

## 六、预期结果

### 6.1 性能指标

| 测试场景 | 无缓存 | 有缓存 | 性能提升 |
|----------|--------|--------|----------|
| 单次调用 (缓存命中) | 250 周期 | 20-50 周期 | 5-12x |
| AI 推理循环 | 1000 ms | 100-150 ms | 6-10x |
| 日志记录 | 500 ms | 150-200 ms | 2.5-3x |
| 性能测量 | 800 ms | 150 ms | 5x |

### 6.2 精度指标

| 指标 | 要求 | 预期 |
|------|------|------|
| 绝对误差 | < 1μs | < 0.5μs |
| 相对误差 | < 10% | < 5% |
| 单调性 | 100% | 100% |
| 时间倒流 | 0 次 | 0 次 |

### 6.3 稳定性指标

| 指标 | 要求 |
|------|------|
| 24小时运行 | 无崩溃 |
| 内存泄漏 | 0 bytes |
| 缓存一致性 | 100% |

---

## 七、测试报告格式

### 7.1 报告模板

```markdown
# RISC-V VDSO 时间缓存测试报告

## 测试信息
- 测试时间: YYYY-MM-DD HH:MM:SS
- 内核版本: Linux x.x.x
- 测试提交: <commit hash>
- 硬件平台: <CPU 信息>

## 测试结果摘要
- 通过用例: X/Y
- 性能提升: Z%
- 精度损失: < A μs

## 详细结果
[各测试用例的详细结果]

## 结论与建议
[测试结论和改进建议]
```

### 7.2 评分标准

| 评分 | 通过率 | 性能提升 | 精度 | 稳定性 |
|------|--------|----------|------|--------|
| 优秀 | ≥ 95% | ≥ 8x | < 0.5μs | 100% |
| 良好 | ≥ 85% | ≥ 5x | < 1μs | 100% |
| 及格 | ≥ 70% | ≥ 3x | < 2μs | ≥ 99% |
| 不及格 | < 70% | < 3x | ≥ 2μs | < 99% |

---

## 八、故障排查

### 8.1 常见问题

| 问题 | 可能原因 | 解决方法 |
|------|----------|----------|
| 性能无提升 | 配置未启用 | 检查 CONFIG_RISCV_VDSO_TIME_CACHE |
| 精度异常 | 缓存实现错误 | 检查代码逻辑 |
| 系统崩溃 | 内存访问错误 | 检查指针和内存布局 |
| 时间倒流 | 多核同步问题 | 检查 generation 机制 |

### 8.2 调试命令

```bash
# 检查内核日志
dmesg | grep -i vdso

# 检查进程绑核
taskset -c 0 ./test_program

# 使用 perf 分析
perf stat -e cycles,instructions,cache-misses ./test_program

# 查看 CSR_TIME 陷阱次数
perf stat -e riscv_ht_instructions_retired ./test_program
```

---

## 九、回归测试清单

- [ ] 原有 VDSO 功能正常
- [ ] clock_gettime() 所有时钟类型正常
- [ ] gettimeofday() 正常
- [ ] time() 系统调用正常
- [ ] 时间命名空间功能正常
- [ ] 多进程/多线程正常
- [ ] 信号处理正常
- [ ] ptrace 功能正常

---

## 十、附录

### A. 测试数据文件格式

```
# test_data.conf
TEST_DURATION=60        # 测试持续时间 (秒)
WARMUP_ITERATIONS=1000  # 预热迭代次数
MEASUREMENT_ITERATIONS=1000000  # 测量迭代次数
EXPECTED_MIN_CYCLES=10  # 最小预期周期
EXPECTED_MAX_CYCLES=50  # 最大预期周期 (缓存命中)
```

### B. 测试环境示例

```
CPU: SiFive U74-MC @ 1.2 GHz
Memory: 8GB DDR4
Kernel: Linux 6.8.0-rc1+ (with VDSO cache patch)
GCC: 13.2.0
```

### C. 性能测试参考值

```
基准测试 (无缓存):
- 单次调用: 250 周期
- 吞吐量: 328,056 calls/sec

优化后 (有缓存):
- 缓存命中: 20-50 周期
- 吞吐量: 2,600,000+ calls/sec
```

---

**文档版本**: v1.0
**创建日期**: 2026-01-10
**作者**: RISC-V VDSO 测试组
